# In your views.py

from django.http import JsonResponse
import subprocess
import re

# Function to validate IP address format
def is_valid_ip(ip):
    pattern = re.compile(r"^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])(\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])){3}$")
    return bool(pattern.match(ip))

# Function to parse nmap output and extract useful information
def parse_nmap_output(output):
    parsed_results = {}

    # Parse open ports and services from nmap output
    for line in output:
        if "open" in line:
            parts = line.split()
            port = parts[0]
            service = parts[2] if len(parts) > 2 else "Unknown Service"
            parsed_results[port] = service

    return parsed_results

# View to handle scanning
def scan_ip(request):
    if request.method == 'POST':
        ip = request.POST.get('ip')  # Get IP from form

        if not ip:
            return JsonResponse({"error": "No IP provided"}, status=400)

        if not is_valid_ip(ip):
            return JsonResponse({"error": "Invalid IP address provided"}, status=400)

        try:
            # Run nmap scan on the provided IP address
            result = subprocess.run(
                ["nmap", "-F", ip],  # "-F" for a fast scan of common ports
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True
            )

            # If nmap fails
            if result.returncode != 0:
                return JsonResponse({"error": f"nmap scan failed: {result.stderr.strip()}"}, status=500)

            # Parse nmap output for useful data (open ports and services)
            parsed_results = parse_nmap_output(result.stdout.splitlines())

            # If no open ports are found
            if not parsed_results:
                return JsonResponse({"ip": ip, "message": "No open ports found"}, status=200)

            # Return parsed results as JSON
            return JsonResponse({"ip": ip, "open_ports": parsed_results})

        except Exception as e:
            return JsonResponse({"error": f"Unexpected error: {str(e)}"}, status=500)
